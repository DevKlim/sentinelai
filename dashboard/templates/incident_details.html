<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sentinel AI - Incident Details</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --background: #000;
        --surface: #1a1a1a;
        --surface-light: #222;
        --primary: #ffc107;
        --text-primary: #e0e0e0;
        --text-secondary: #ccc;
        --border-color: #333;
        --danger: #d9534f;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: var(--background);
        color: var(--text-primary);
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 2rem;
      }

      .header {
        background: var(--surface);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }
      .header-info h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 0.5rem;
      }
      .header-info p {
        color: var(--text-secondary);
        font-size: 1.1rem;
        font-weight: 300;
        text-transform: capitalize;
      }
      .header .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .incident-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        align-items: flex-start;
      }

      .incident-card {
        background: var(--surface);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        display: flex;
        flex-direction: column;
      }

      .side-column .incident-card {
        margin-bottom: 2rem;
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
      }
      .card-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
      }
      .card-header h2 i {
        margin-right: 0.75rem;
      }
      .edit-controls {
        display: none;
        gap: 0.5rem;
      }
      .is-editing .edit-controls {
        display: flex;
      }
      .is-editing #edit-overview-btn {
        display: none;
      }

      .key-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .stat-card {
        background: var(--surface-light);
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid var(--primary);
      }
      .stat-card .label {
        font-size: 0.9rem;
        color: #aaa;
        margin-bottom: 0.25rem;
        display: block;
      }
      .stat-card .value {
        font-size: 1.2rem;
        font-weight: 600;
        color: #fff;
      }
      .stat-card .value input {
        width: 100%;
        background: #333;
        border: 1px solid #555;
        border-radius: 4px;
        color: #fff;
        font-size: 1.1rem;
        padding: 4px;
      }

      .report-list {
        list-style: none;
        max-height: 600px;
        overflow-y: auto;
        padding-right: 10px;
      }
      .report-item {
        background: var(--surface-light);
        border: 1px solid #444;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
      }
      .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      .report-header h3 {
        font-size: 1.2rem;
      }
      .report-actions {
        display: flex;
        gap: 0.5rem;
      }

      .action-btn {
        background: #333;
        color: var(--text-primary);
        border: 1px solid #555;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      .action-btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }
      .action-btn:hover:not(:disabled) {
        background-color: #444;
      }
      .delete-btn {
        background-color: var(--danger);
        color: #fff;
      }
      .delete-btn:hover {
        background-color: #c9302c;
      }
      .download-btn {
        background: var(--primary);
        color: #000;
        border-color: var(--primary);
      }
      .download-btn:hover {
        background-color: #ffda6a;
      }

      .json-editor-container {
        margin-top: 1rem;
      }
      .json-editor-container textarea {
        width: 100%;
        min-height: 300px;
        background: #111;
        border: 1px solid #555;
        color: #ddd;
        font-family: monospace;
        padding: 1rem;
        border-radius: 8px;
      }
      .editor-controls {
        margin-top: 0.5rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
      }

      .back-link {
        display: inline-flex;
        align-items: center;
        color: var(--text-primary);
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
        padding: 0.75rem 1.5rem;
        background: var(--surface);
        border: 1px solid var(--border-color);
        border-radius: 8px;
      }
      .back-link:hover {
        border-color: var(--primary);
        transform: translateX(-5px);
      }
      .back-link i {
        margin-right: 0.5rem;
      }

      .fa-spin {
        animation: fa-spin 1s infinite linear;
      }
      @keyframes fa-spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .loading-placeholder {
        text-align: center;
        padding: 2rem;
        color: #888;
        font-style: italic;
      }

      /* New Chat/Agent Styles */
      #assistant-card {
        flex-grow: 1; /* Allows the card to grow */
      }
      #chat-container {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        height: 450px; /* Or a fixed height */
      }
      #chat-history {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
        background: var(--surface-light);
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
      }
      .chat-message {
        margin-bottom: 1rem;
        display: flex;
      }
      .chat-message .icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
      }
      .chat-message .text {
        padding: 0.75rem 1rem;
        border-radius: 12px;
        max-width: 85%;
        word-wrap: break-word;
      }
      .user-message .icon {
        background: #444;
      }
      .user-message .text {
        background: #333;
        border-top-left-radius: 0;
      }
      .assistant-message .icon {
        background: var(--primary);
        color: #000;
      }
      .assistant-message .text {
        background: #2a2a2a;
        border-top-right-radius: 0;
      }
      .assistant-message .text p {
        margin-bottom: 0.5rem;
      }
      .assistant-message .text ul {
        padding-left: 20px;
      }
      #chat-form {
        display: flex;
        gap: 0.5rem;
      }
      #chat-input {
        flex-grow: 1;
        padding: 0.75rem;
        background: #222;
        border: 1px solid #444;
        color: var(--text-primary);
        border-radius: 8px;
        font-size: 1rem;
      }
      #chat-input:focus {
        outline: none;
        border-color: var(--primary);
      }
      .suggestion-btn {
        background-color: #333;
        border: 1px solid #555;
        color: var(--text-primary);
        padding: 8px 12px;
        border-radius: 15px;
        cursor: pointer;
        margin: 4px;
        display: inline-block;
        transition: background-color 0.2s;
      }
      .suggestion-btn:hover {
        background-color: #444;
      }
      .management-section {
        margin-bottom: 1.5rem;
      }
      .management-section:last-child {
        margin-bottom: 0;
      }

      /* Toast Notifications */
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #222;
        color: #fff;
        padding: 1rem 2rem;
        border-radius: 8px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }
      .toast.show {
        opacity: 1;
      }
      .toast.success {
        background: #5cb85c;
      }
      .toast.error {
        background: var(--danger);
      }
      @media (max-width: 900px) {
        .incident-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/dashboard/" class="back-link">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
      <div class="header">
        <div class="header-info">
          <h1 id="incident-title">{{ incident.name }}</h1>
          <p>
            Status: <span id="incident-status">{{ incident.status }}</span> |
            Type: {{ incident.incident_type }}
          </p>
        </div>
        <div class="actions">
          <button
            class="action-btn download-btn"
            onclick="downloadIncident('{{ incident.incident_id }}')"
          >
            <i class="fas fa-file-archive"></i> Download Incident (ZIP)
          </button>
          {% if incident.status.lower() == 'open' %}
          <button
            id="close-incident-btn"
            class="action-btn"
            style="background-color: #5cb85c; color: #fff"
            onclick="closeIncident('{{ incident.incident_id }}')"
          >
            <i class="fas fa-check-circle"></i> Close Incident
          </button>
          {% endif %}
        </div>
      </div>

      <div class="incident-grid">
        <div class="main-column">
          <div class="incident-card" id="tactical-overview-card">
            <div class="card-header">
              <h2>
                <i class="fas fa-sitemap"></i> Tactical Overview (Latest Report)
              </h2>
              <div>
                <button
                  id="edit-overview-btn"
                  class="action-btn"
                  onclick="toggleOverviewEdit(true)"
                >
                  <i class="fas fa-edit"></i> Edit
                </button>
                <div class="edit-controls">
                  <button
                    class="action-btn"
                    onclick="toggleOverviewEdit(false)"
                  >
                    <i class="fas fa-times"></i> Cancel
                  </button>
                  <button
                    class="action-btn download-btn"
                    onclick="saveOverviewChanges('{{ incident.incident_id }}')"
                  >
                    <i class="fas fa-save"></i> Save
                  </button>
                </div>
              </div>
            </div>
            <div class="key-info-grid" id="key-info-grid">
              <!-- Dynamically populated and made editable by JS -->
            </div>
          </div>

          <div class="incident-card">
            <div class="card-header">
              <h2>
                <i class="fas fa-receipt"></i> EIDO Reports ({{
                incident.reports|length }})
              </h2>
            </div>
            <ul class="report-list">
              {% if incident.reports %} {% for report in incident.reports %}
              <li class="report-item" data-report-id="{{ report.id }}">
                <div class="report-header">
                  <h3>
                    Report #{{ loop.index }}
                    <small>({{ report.id[:8] }})</small>
                  </h3>
                  <div class="report-actions">
                    <button
                      class="action-btn"
                      onclick="toggleJsonEditor('{{ report.id }}')"
                    >
                      <i class="fas fa-code"></i> Edit JSON
                    </button>
                  </div>
                </div>
                <p><strong>Timestamp:</strong> {{ report.timestamp }}</p>
                <p><strong>Source:</strong> {{ report.source }}</p>
                <div
                  class="json-editor-container"
                  id="editor-container-{{ report.id }}"
                  style="display: none"
                >
                  <textarea id="json-textarea-{{ report.id }}"></textarea>
                  <div class="editor-controls">
                    <button
                      class="action-btn"
                      onclick="toggleJsonEditor('{{ report.id }}')"
                    >
                      Cancel
                    </button>
                    <button
                      class="action-btn download-btn"
                      onclick="saveJsonChanges('{{ report.id }}')"
                    >
                      Save JSON
                    </button>
                  </div>
                </div>
              </li>
              {% endfor %} {% else %}
              <p>No EIDO reports found for this incident.</p>
              {% endif %}
            </ul>
          </div>
        </div>

        <div class="side-column">
          <div class="incident-card" id="assistant-card">
            <div class="card-header">
              <h2><i class="fas fa-robot"></i> Incident Assistant</h2>
            </div>
            <div id="chat-container">
              <div id="chat-history">
                <!-- Chat messages will be appended here -->
              </div>
              <form id="chat-form">
                <input
                  type="text"
                  id="chat-input"
                  placeholder="Ask about the incident or request an action..."
                  autocomplete="off"
                />
                <button type="submit" class="action-btn download-btn">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </form>
            </div>
          </div>
          <div class="incident-card">
            <div class="card-header">
              <h2><i class="fas fa-cogs"></i> Manage Incident</h2>
            </div>
            <div class="management-section">
              <h4>Rename Incident</h4>
              <div style="display: flex; gap: 0.5rem">
                <input
                  type="text"
                  id="new-name-input"
                  value="{{ incident.name }}"
                  style="
                    flex-grow: 1;
                    padding: 0.5rem;
                    border-radius: 6px;
                    border: 1px solid #444;
                    background: #222;
                    color: #e0e0e0;
                  "
                />
                <button
                  class="action-btn"
                  onclick="renameIncident('{{ incident.incident_id }}')"
                >
                  Rename
                </button>
              </div>
            </div>
            <div class="management-section">
              <h4>Actions</h4>
              <button
                id="delete-incident-btn"
                class="action-btn delete-btn"
                style="width: 100%; justify-content: center"
                onclick="deleteIncident('{{ incident.incident_id }}')"
              >
                <i class="fas fa-trash"></i> Delete Entire Incident
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="toast" class="toast"></div>
    <script id="incident-data" type="application/json">
      {{ incident | tojson | safe }}
    </script>
    <script>
      const incidentData = JSON.parse(
        document.getElementById("incident-data").textContent
      );

      // --- Core Functions ---
      async function apiFetch(url, options) {
        const response = await fetch(url, options);
        if (!response.ok) {
          const errorData = await response
            .json()
            .catch(() => ({ detail: "An unknown error occurred." }));
          throw new Error(
            errorData.detail || `Request failed with status ${response.status}`
          );
        }
        if (response.status === 204) return null;
        return response.json();
      }

      let toastTimeout;
      function showToast(message, type = "info") {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => toast.classList.remove("show"), 3000);
      }

      // --- Incident Management Actions ---
      async function closeIncident(incidentId) {
        if (!confirm("Are you sure you want to close this incident?")) return;
        try {
          await apiFetch(`/dashboard/api/incidents/${incidentId}/close`, {
            method: "POST",
          });
          showToast("Incident closed successfully!", "success");
          document.getElementById("incident-status").textContent = "closed";
          document.getElementById("close-incident-btn")?.remove();
        } catch (error) {
          showToast(`Error: ${error.message}`, "error");
        }
      }
      async function renameIncident(incidentId) {
        const newName = document.getElementById("new-name-input").value.trim();
        if (!newName) {
          showToast("Incident name cannot be empty.", "error");
          return;
        }
        try {
          const data = await apiFetch(
            `/dashboard/api/incidents/${incidentId}/rename`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name: newName }),
            }
          );
          showToast("Incident renamed successfully!", "success");
          document.getElementById("incident-title").textContent = data.name;
        } catch (error) {
          showToast(`Error: ${error.message}`, "error");
        }
      }
      async function deleteIncident(incidentId) {
        if (
          !confirm(
            "Are you sure you want to permanently delete this incident? This action cannot be undone."
          )
        )
          return;
        try {
          await apiFetch(`/dashboard/api/incidents/${incidentId}`, {
            method: "DELETE",
          });
          showToast("Incident deleted successfully. Redirecting...", "success");
          setTimeout(() => (window.location.href = "/dashboard/"), 1500);
        } catch (error) {
          showToast(`Error: ${error.message}`, "error");
        }
      }
      function downloadIncident(incidentId) {
        window.location.href = `/dashboard/api/incidents/${incidentId}/download`;
      }

      // --- EIDO JSON Editing ---
      function toggleJsonEditor(reportId) {
        const container = document.getElementById(
          `editor-container-${reportId}`
        );
        const report = incidentData.reports.find((r) => r.id === reportId);
        if (!report) return;

        const isVisible = container.style.display === "block";
        if (!isVisible) {
          const textarea = document.getElementById(`json-textarea-${reportId}`);
          textarea.value = JSON.stringify(report.original_eido, null, 2);
        }
        container.style.display = isVisible ? "none" : "block";
      }
      async function saveJsonChanges(reportId) {
        const textarea = document.getElementById(`json-textarea-${reportId}`);
        let updatedJson;
        try {
          updatedJson = JSON.parse(textarea.value);
        } catch (e) {
          showToast("Invalid JSON. Please check the syntax.", "error");
          return;
        }
        try {
          await apiFetch(`/dashboard/api/eidos/${reportId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ original_eido: updatedJson }),
          });
          showToast(
            "EIDO report updated successfully. Reloading page...",
            "success"
          );
          setTimeout(() => location.reload(), 1500);
        } catch (error) {
          showToast(`Error: ${error.message}`, "error");
        }
      }

      // --- Tactical Overview Editing ---
      function toggleOverviewEdit(isEditing) {
        const card = document.getElementById("tactical-overview-card");
        card.classList.toggle("is-editing", isEditing);
        document.querySelectorAll("#key-info-grid .value").forEach((el) => {
          const input = el.querySelector("input");
          if (isEditing) {
            if (!input) {
              const currentText = el.textContent;
              el.innerHTML = `<input type="text" value="${currentText}" />`;
            }
          } else {
            if (input) {
              el.textContent = input.dataset.originalValue;
            }
          }
        });
      }

      async function saveOverviewChanges(incidentId) {
        const stats = {};
        let hasChanges = false;
        document
          .querySelectorAll("#key-info-grid .stat-card")
          .forEach((card) => {
            const input = card.querySelector(".value input");
            if (input) {
              const key = card.dataset.statKey;
              const originalValue = input.dataset.originalValue;
              const newValue = input.value;
              if (newValue !== originalValue) {
                stats[key] = newValue;
                hasChanges = true;
              }
            }
          });

        if (!hasChanges) {
          showToast("No changes to save.", "info");
          toggleOverviewEdit(false);
          return;
        }

        try {
          showToast("Updating with AI assistance... Please wait.", "info");
          await apiFetch(
            `/dashboard/api/incidents/${incidentId}/update_stats`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ stats }),
            }
          );
          showToast(
            "Overview updated successfully! Reloading page...",
            "success"
          );
          setTimeout(() => location.reload(), 1500);
        } catch (error) {
          showToast(`Error updating overview: ${error.message}`, "error");
        }
      }

      // --- Incident Assistant / Chat ---
      const chatHistory = document.getElementById("chat-history");
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");

      function appendMessage(role, text) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("chat-message", `${role}-message`);
        const icon = role === "user" ? "fa-user" : "fa-robot";
        messageDiv.innerHTML = `
          <div class="icon"><i class="fas ${icon}"></i></div>
          <div class="text">${text}</div>
        `;
        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      function handleSuggestionClick(suggestion) {
        chatInput.value = suggestion;
        chatInput.focus();
      }

      async function fetchInitialSuggestions(incidentId) {
        appendMessage(
          "assistant",
          '<i class="fas fa-spinner fa-spin"></i> Generating initial analysis and suggestions...'
        );
        try {
          const data = await apiFetch(
            `/dashboard/api/incidents/${incidentId}/predict_actions`,
            { method: "POST" }
          );
          chatHistory.lastChild.remove(); // Remove spinner

          let html = `<p><strong>Prediction:</strong> ${
            data.prediction_summary || "N/A"
          }</p>
                          <p><strong>Suggested Actions:</strong></p>`;

          (data.suggested_actions || []).forEach((action) => {
            html += `<button class="suggestion-btn" onclick="handleSuggestionClick('${action.replace(
              /'/g,
              "\\'"
            )}')">${action}</button>`;
          });
          appendMessage("assistant", html);
        } catch (error) {
          chatHistory.lastChild.remove(); // Remove spinner
          appendMessage(
            "assistant",
            `Could not generate suggestions: ${error.message}`
          );
        }
      }

      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const query = chatInput.value.trim();
        if (!query) return;

        appendMessage("user", query);
        chatInput.value = "";
        appendMessage("assistant", '<i class="fas fa-spinner fa-spin"></i>');

        const historyElements = Array.from(
          chatHistory.querySelectorAll(".chat-message")
        );
        const chat_history = historyElements.slice(0, -2).map((el) => ({
          role: el.classList.contains("user-message") ? "user" : "assistant",
          content: el.querySelector(".text").textContent,
        }));

        try {
          const response = await apiFetch(
            `/dashboard/api/incidents/${incidentData.incident_id}/agentic_query`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ query, chat_history }),
            }
          );
          chatHistory.lastChild.querySelector(".text").innerHTML =
            response.response.replace(/\n/g, "<br>");
        } catch (error) {
          chatHistory.lastChild.querySelector(
            ".text"
          ).innerHTML = `Error: ${error.message}`;
        }
      });

      // --- Page Initialization ---
      function populateTacticalOverview() {
        const grid = document.getElementById("key-info-grid");
        if (!incidentData.reports || incidentData.reports.length === 0) {
          grid.innerHTML = "<p>No report data available to display.</p>";
          document.getElementById("edit-overview-btn").style.display = "none";
          return;
        }

        const latestEido = incidentData.reports[0].original_eido;
        if (!latestEido) {
          grid.innerHTML = "<p>Latest report contains no EIDO JSON.</p>";
          document.getElementById("edit-overview-btn").style.display = "none";
          return;
        }

        const stats = {
          priority:
            latestEido.incidentComponent?.incidentCommonPriorityNumber || "N/A",
          status:
            latestEido.incidentComponent
              ?.incidentStatusCommonRegistryText?.[0] || "Unknown",
          victims: (latestEido.personComponent || []).filter(
            (p) => p.personIncidentRoleRegistryText?.[0] === "Victim"
          ).length,
          suspects: (latestEido.personComponent || []).filter(
            (p) => p.personIncidentRoleRegistryText?.[0] === "Suspect"
          ).length,
          units: (latestEido.emergencyResourceComponent || []).length,
          motive: "Not Found",
        };
        const notes =
          latestEido.notesComponent?.find(
            (n) => n.$id === "notes-when-motive-status"
          )?.notesActionComments || "";
        const motiveMatch = notes.match(/Motive:\s*([^\n\.]+)/i);
        if (motiveMatch) stats.motive = motiveMatch[1].trim();

        grid.innerHTML = `
          <div class="stat-card" data-stat-key="priority"><span class="label">Priority</span><span class="value">${stats.priority}</span></div>
          <div class="stat-card" data-stat-key="status"><span class="label">Status</span><span class="value">${stats.status}</span></div>
          <div class="stat-card" data-stat-key="motive"><span class="label">Motive</span><span class="value">${stats.motive}</span></div>
          <div class="stat-card" data-stat-key="victims"><span class="label">Victims</span><span class="value">${stats.victims}</span></div>
          <div class="stat-card" data-stat-key="suspects"><span class="label">Suspects</span><span class="value">${stats.suspects}</span></div>
          <div class="stat-card" data-stat-key="units"><span class="label">Units</span><span class="value">${stats.units}</span></div>
        `;
        // Store original values for comparison on save
        document.querySelectorAll("#key-info-grid .value").forEach((el) => {
          const input = document.createElement("input");
          input.dataset.originalValue = el.textContent;
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        populateTacticalOverview();
        if (incidentData && incidentData.incident_id) {
          fetchInitialSuggestions(incidentData.incident_id);
        }
      });
    </script>
  </body>
</html>
