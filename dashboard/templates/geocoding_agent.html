<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Geocoding Agent - Sentinel AI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      :root {
        --background: #000; --surface: #1a1a1a; --primary: #ffc107;
        --text-primary: #e0e0e0; --text-secondary: #ccc; --border-color: #333;
        --danger: #d9534f; --success: #5cb85c;
      }
      body { font-family: 'Inter', sans-serif; background: var(--background); color: var(--text-primary); }
      .container { max-width: 1400px; margin: 2rem auto; padding: 2rem; }
      .main-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 2rem; align-items: flex-start; }
      .card { background: var(--surface); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; }
      .card h2 { font-size: 1.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: .5rem; }
      .form-group { margin-bottom: 1rem; }
      .form-label { display: block; font-weight: 500; margin-bottom: .5rem; }
      .form-textarea { width: 100%; padding: .75rem; background: #222; border: 1px solid #444; border-radius: 6px; color: var(--text-primary); font-size: 1rem; resize: vertical; min-height: 120px; }
      .btn { padding: .75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 500; border: 1px solid transparent; transition: all .2s ease; }
      .btn-primary { background: var(--primary); color: #000; border-color: var(--primary); }
      .btn-primary:disabled { background: #555; border-color: #555; cursor: not-allowed; }
      #map { height: 600px; border-radius: 8px; background-color: #333; }
      .result-card { margin-top: 1.5rem; display: none; }
      .back-link { display: inline-flex; align-items: center; color: var(--text-primary); text-decoration: none; margin-bottom: 2rem; padding: 0.75rem 1.5rem; background: var(--surface); border: 1px solid var(--border-color); border-radius: 8px; }
      .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #222; color: #fff; padding: 1rem 2rem; border-radius: 8px; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
      .toast.show { opacity: 1; } .toast.success { background: var(--success); } .toast.error { background: var(--danger); }
      .fa-spin { animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
      .agent-trace-container { margin-top: 1.5rem; }
      .agent-step { background: #222; border-left: 3px solid var(--primary); padding: 1rem; margin-bottom: 0.75rem; border-radius: 0 8px 8px 0; display: none; }
      .agent-step.visible { display: block; animation: fadeIn .5s forwards; }
      @keyframes fadeIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
      .agent-step strong { color: var(--primary); display: block; margin-bottom: .5rem; font-size: 1.1em; }
      .agent-step p { margin: 0; color: var(--text-secondary); }
      .agent-step pre { background: #111; padding: .5rem; border-radius: 4px; margin-top: .5rem; white-space: pre-wrap; word-break: break-all; font-size: 0.9em; max-height: 200px; overflow-y: auto; }
      .agent-step.status-failure { border-left-color: var(--danger); }
      .agent-step.status-failure strong { color: var(--danger); }
    </style>
</head>
<body>
<div class="container">
    <a href="/dashboard/" class="back-link"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    <h1><i class="fas fa-brain"></i> Agentic Geocoding</h1>
    <p style="margin-top:-0.5rem; margin-bottom:2rem; color: var(--text-secondary);">An advanced agent to find locations from natural language descriptions.</p>
    <div class="main-grid">
        <!-- Left Column -->
        <div>
            <div class="card">
                <h2><i class="fas fa-search-location"></i> Geocode Location</h2>
                <form id="geocode-form">
                    <div class="form-group">
                        <label for="description" class="form-label">Location Description</label>
                        <textarea id="description" class="form-textarea" placeholder="e.g., 'the biggest library in UC San Diego'" required></textarea>
                    </div>
                    <button type="submit" id="geocode-btn" class="btn btn-primary" style="width:100%;"><i class="fas fa-map-marker-alt"></i> Pinpoint Location</button>
                </form>
            </div>

            <div class="card agent-trace-container">
                <h2><i class="fas fa-project-diagram"></i> Agent Steps</h2>
                <div id="agent-trace">
                    <p style="color:#888;">Agent's thought process will appear here...</p>
                </div>
            </div>
        </div>
        <!-- Right Column -->
        <div>
            <div class="card">
                <h2><i class="fas fa-map"></i> Map View</h2>
                <div id="map"></div>
                <div class="card result-card" id="result-card">
                    <h4><i class="fas fa-check-circle"></i> Final Result</h4>
                    <p><strong>Coordinates:</strong> <span id="result-coords"></span></p>
                    <p><strong>Confidence:</strong> <span id="result-confidence"></span></p>
                    <p><strong>Agent Reasoning:</strong> <span id="result-reasoning"></span></p>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="toast" class="toast"></div>

<script>
    const map = L.map('map').setView([32.8801, -117.2340], 15); // Default to UCSD
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
    }).addTo(map);

    let resultMarker = null;

    let toastTimeout;
    function showToast(message, type = "info") {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => toast.classList.remove("show"), 5000);
    }

    document.getElementById('geocode-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const description = document.getElementById('description').value;
        const btn = document.getElementById('geocode-btn');
        const traceContainer = document.getElementById('agent-trace');
        const resultCard = document.getElementById('result-card');

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Agent is Thinking...';
        btn.disabled = true;
        traceContainer.innerHTML = '<p style="color:#888;">Initializing agent...</p>';
        resultCard.style.display = 'none';
        if (resultMarker) map.removeLayer(resultMarker);

        try {
            const response = await fetch('/dashboard/api/geo/geocode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text_description: description })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.detail || "An unknown error occurred.");

            traceContainer.innerHTML = '';
            let totalDelay = 0;
            const stepDelay = 600;

            result.agent_trace.forEach((step, index) => {
                setTimeout(() => {
                    const stepEl = document.createElement('div');
                    stepEl.className = 'agent-step';
                    if (step.status === 'Failure') {
                        stepEl.classList.add('status-failure');
                    }
                    const resultText = step.result ? `<pre>${JSON.stringify(step.result, null, 2)}</pre>` : '';

                    stepEl.innerHTML = `
                        <strong><i class="fas fa-chevron-right"></i> Step ${step.step_number}: ${step.step_name} (${step.status})</strong>
                        <p>${step.details}</p>
                        ${resultText}
                    `;
                    traceContainer.appendChild(stepEl);
                    stepEl.classList.add('visible');
                }, index * stepDelay);
                totalDelay = (index + 1) * stepDelay;
            });

            setTimeout(() => {
                 if (result.confidence > 0) {
                    resultCard.style.display = 'block';
                    document.getElementById('result-coords').textContent = `${result.latitude.toFixed(5)}, ${result.longitude.toFixed(5)}`;
                    document.getElementById('result-confidence').textContent = `${(result.confidence * 100).toFixed(1)}%`;
                    document.getElementById('result-reasoning').textContent = result.reasoning;
                    
                    const latlng = [result.latitude, result.longitude];
                    resultMarker = L.marker(latlng).addTo(map);
                    resultMarker.bindPopup(`<b>Final Location</b><br>Confidence: ${(result.confidence * 100).toFixed(1)}%`).openPopup();
                    map.setView(latlng, 17);
                 } else {
                     showToast("Agent could not determine a location.", 'error');
                 }

                btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Pinpoint Location';
                btn.disabled = false;
            }, totalDelay);

        } catch (error) {
            showToast(`Error: ${error.message}`, 'error');
            traceContainer.innerHTML = `<div class="agent-step visible status-failure"><strong><i class="fas fa-exclamation-triangle"></i> System Error</strong><p>${error.message}</p></div>`;
            btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Pinpoint Location';
            btn.disabled = false;
        }
    });
</script>
</body>
</html>
