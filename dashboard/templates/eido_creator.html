<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EIDO Template Creator - Sentinel AI</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: #000;
        color: #e0e0e0;
        margin: 0;
      }
      .container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 2rem;
      }
      .header h1 {
        font-size: 2.5rem;
        color: #ffc107;
        text-align: center;
        margin-bottom: 1rem;
      }
      .header p {
        text-align: center;
        color: #aaa;
        margin-bottom: 2rem;
      }
      .creator-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        align-items: flex-start;
      }
      .card {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 2rem;
      }
      .card h2 {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #333;
        padding-bottom: 0.75rem;
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
      }
      .form-textarea,
      .form-input {
        width: 100%;
        padding: 1rem;
        border: 1px solid #444;
        border-radius: 8px;
        font-size: 1rem;
        background: #222;
        color: #e0e0e0;
        resize: vertical;
        box-sizing: border-box;
      }
      .form-textarea {
        min-height: 250px;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        border: 1px solid #ffc107;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #ffc107;
        color: #000;
      }
      .btn:disabled {
        background: #555;
        border-color: #555;
        color: #999;
        cursor: not-allowed;
      }
      .btn i {
        margin-right: 0.5rem;
      }
      #result-container pre {
        background: #111;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        font-size: 0.9rem;
        max-height: 500px;
      }
      .save-section {
        display: none;
        margin-top: 1.5rem;
      }
      .template-list ul {
        list-style: none;
        padding: 0;
        max-height: 300px;
        overflow-y: auto;
      }
      .template-list li {
        background: #222;
        padding: 0.75rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
      }
      .back-link {
        display: inline-flex;
        align-items: center;
        color: #e0e0e0;
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
        padding: 0.75rem 1.5rem;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
      }
      .back-link:hover {
        border-color: #ffc107;
      }
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #222;
        color: #fff;
        padding: 1rem 2rem;
        border-radius: 8px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }
      .toast.show {
        opacity: 1;
      }
      .toast.success {
        background: #5cb85c;
      }
      .toast.error {
        background: #d9534f;
      }
      .fa-spin {
        animation: fa-spin 1s infinite linear;
      }
      @keyframes fa-spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/dashboard/" class="back-link"
        ><i class="fas fa-arrow-left"></i> Back to Dashboard</a
      >
      <div class="header">
        <h1>EIDO Template Creator</h1>
        <p>
          Describe the incident template you need, and let the AI build it for
          you.
        </p>
      </div>
      <div class="creator-grid">
        <div class="card">
          <h2>1. Describe Your Template</h2>
          <form id="creator-form">
            <div class="form-group">
              <label for="template-description" class="form-label"
                >Template Requirements</label
              >
              <textarea
                id="template-description"
                class="form-textarea"
                placeholder="e.g., 'A template for a structure fire at a commercial building. It should include details for multiple fire engines and at least one ladder truck. Also, add fields for a primary and secondary point of contact for the business owner.'"
              ></textarea>
            </div>
            <button type="submit" id="generate-btn" class="btn">
              <i class="fas fa-cogs"></i> Generate Template
            </button>
          </form>

          <div class="card" style="margin-top: 2rem">
            <h2>Existing Templates</h2>
            <div id="template-list" class="template-list">
              <ul>
                <!-- Populated by JS -->
              </ul>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>2. Generated Template</h2>
          <div id="result-container">
            <pre><code id="result-json" class="language-json" style="white-space: pre-wrap;">Your generated template will appear here...</code></pre>
          </div>
          <div id="save-section" class="save-section">
            <hr style="border-color: #333; margin-bottom: 1.5rem" />
            <h3>3. Save New Template</h3>
            <form id="save-form">
              <div class="form-group">
                <label for="template-filename" class="form-label"
                  >Filename</label
                >
                <input
                  type="text"
                  id="template-filename"
                  class="form-input"
                  placeholder="e.g., commercial_fire_incident.json"
                  required
                  pattern="^[a-zA-Z0-9_.-]+\.json$"
                  title="Must be a valid filename ending in .json"
                />
              </div>
              <button type="submit" id="save-btn" class="btn">
                <i class="fas fa-save"></i> Save to EIDO Agent
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div id="toast" class="toast"></div>

    <script>
      const creatorForm = document.getElementById("creator-form");
      const generateBtn = document.getElementById("generate-btn");
      const resultJson = document.getElementById("result-json");
      const saveSection = document.getElementById("save-section");
      const saveForm = document.getElementById("save-form");
      const templateList = document
        .getElementById("template-list")
        .querySelector("ul");
      let generatedTemplateContent = null;

      async function fetchTemplates() {
        try {
          const response = await fetch("/dashboard/api/eido/templates");
          if (!response.ok) throw new Error("Failed to load templates");
          const templates = await response.json();
          templateList.innerHTML = templates
            .map((t) => `<li>${t}</li>`)
            .join("");
        } catch (error) {
          templateList.innerHTML = `<li>Error: ${error.message}</li>`;
        }
      }

      creatorForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const description = document
          .getElementById("template-description")
          .value.trim();
        if (!description) {
          showToast("Please enter a description for the template.", "error");
          return;
        }

        generateBtn.disabled = true;
        generateBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Generating...';
        resultJson.textContent = "Generating template, please wait...";
        saveSection.style.display = "none";

        try {
          const response = await fetch(
            "/dashboard/api/eido/templates/generate",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ description }),
            }
          );
          const result = await response.json();
          if (!response.ok)
            throw new Error(result.detail || "Failed to generate template.");

          generatedTemplateContent = result.generated_template;
          resultJson.textContent = JSON.stringify(
            generatedTemplateContent,
            null,
            2
          );
          saveSection.style.display = "block";
          showToast("Template generated successfully!", "success");
        } catch (error) {
          resultJson.textContent = `Error: ${error.message}`;
          showToast(error.message, "error");
        } finally {
          generateBtn.disabled = false;
          generateBtn.innerHTML =
            '<i class="fas fa-cogs"></i> Generate Template';
        }
      });

      saveForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const filename = document
          .getElementById("template-filename")
          .value.trim();
        if (!filename || !generatedTemplateContent) {
          showToast(
            "Invalid filename or no template content to save.",
            "error"
          );
          return;
        }

        try {
          const response = await fetch("/dashboard/api/eido/templates/save", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              filename,
              content: generatedTemplateContent,
            }),
          });
          const result = await response.json();
          if (!response.ok)
            throw new Error(result.detail || "Failed to save template.");

          showToast(result.message, "success");
          fetchTemplates(); // Refresh the list
          saveForm.reset();
          saveSection.style.display = "none";
        } catch (error) {
          showToast(error.message, "error");
        }
      });

      let toastTimeout;
      function showToast(message, type = "info") {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => toast.classList.remove("show"), 3000);
      }

      document.addEventListener("DOMContentLoaded", fetchTemplates);
    </script>
  </body>
</html>
